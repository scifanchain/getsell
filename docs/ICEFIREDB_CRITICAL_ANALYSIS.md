# IceFireDB-SQLite æ·±åº¦æŠ€æœ¯åˆ†æä¸é£é™©è¯„ä¼°

## âš ï¸ æ‰§è¡Œæ‘˜è¦ï¼šä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ

ç»è¿‡å¯¹ IceFireDB-SQLite æºä»£ç çš„æ·±å…¥åˆ†æï¼Œ**æˆ‘å¿…é¡»æ”¶å›ä¹‹å‰çš„æ¨è**ã€‚è¿™ä¸ªæ–¹æ¡ˆå­˜åœ¨å¤šä¸ªä¸¥é‡çš„æ¶æ„ç¼ºé™·ï¼Œä¸é€‚åˆä½œä¸ºå»ä¸­å¿ƒåŒ–å†™ä½œè½¯ä»¶çš„æ•°æ®åŒæ­¥åŸºç¡€ã€‚

---

## ğŸ” æ ¸å¿ƒå®ç°æœºåˆ¶åˆ†æ

### åŒæ­¥æµç¨‹

```go
// 1. æœ¬åœ°æ‰§è¡Œ SQL
func Exec(sql string) (*mysql.Result, error) {
    // å…ˆåœ¨æœ¬åœ° SQLite æ‰§è¡Œ
    result, err := db.Exec(sql)
    
    // å¦‚æœæ˜¯ DML æ“ä½œï¼Œå¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹
    if config.Get().P2P.Enable {
        p2pPubSub.Outbound <- sql  // ğŸš¨ é—®é¢˜ï¼šç›´æ¥å¹¿æ’­ SQL å­—ç¬¦ä¸²
        logrus.Infof("Outbound sql: %s", sql)
    }
    return result, nil
}

// 2. å…¶ä»–èŠ‚ç‚¹æ¥æ”¶å¹¶æ‰§è¡Œ
func asyncSQL(ctx context.Context) {
    for {
        select {
        case s := <-p2pPubSub.Inbound:
            _, err := db.Exec(s.Message)  // ğŸš¨ é—®é¢˜ï¼šç›²ç›®æ‰§è¡Œæ¥æ”¶åˆ°çš„ SQL
            if err != nil {
                logrus.Infof("Inbound sql: %s err: %v", s, err)
            }
        }
    }
}
```

### P2P ç½‘ç»œ

```go
// ä½¿ç”¨ libp2p PubSub å¹¿æ’­
type PubSub struct {
    Topic    *pubsub.Topic
    Sub      *pubsub.Subscription
    Inbound  chan *Message
    Outbound chan string
}

func (ps *PubSub) handleOutbound(ctx context.Context) {
    for msg := range ps.Outbound {
        if err := ps.Topic.Publish(ctx, []byte(msg)); err != nil {
            logrus.Errorf("Failed to publish message: %v", err)
        }
    }
}
```

---

## ğŸš¨ ä¸¥é‡é—®é¢˜æ¸…å•

### 1ï¸âƒ£ **è‡´å‘½ç¼ºé™·ï¼šæ— å†²çªè§£å†³æœºåˆ¶**

#### é—®é¢˜æè¿°
```
è®¾å¤‡ A: UPDATE contents SET title='æ ‡é¢˜A' WHERE id='123' AT 10:00:00.100
è®¾å¤‡ B: UPDATE contents SET title='æ ‡é¢˜B' WHERE id='123' AT 10:00:00.101

ç»“æœï¼šä¾èµ–äºç½‘ç»œå»¶è¿Ÿå’Œæ¶ˆæ¯åˆ°è¾¾é¡ºåº
â†’ è®¾å¤‡ A å¯èƒ½æœ€ç»ˆæ˜¯"æ ‡é¢˜B"
â†’ è®¾å¤‡ B å¯èƒ½æœ€ç»ˆæ˜¯"æ ‡é¢˜A"
â†’ æˆ–è€…ä¸¤ä¸ªè®¾å¤‡ç»“æœä¸ä¸€è‡´ï¼
```

#### è¯æ®
```go
// IceFireDB-SQLite æºç 
case s := <-p2pPubSub.Inbound:
    _, err := db.Exec(s.Message)  // æ²¡æœ‰ä»»ä½•å†²çªæ£€æµ‹
    // æ²¡æœ‰ç‰ˆæœ¬å·
    // æ²¡æœ‰æ—¶é—´æˆ³æ¯”è¾ƒ
    // æ²¡æœ‰ CRDT
    // å®Œå…¨ä¾èµ–æ¶ˆæ¯åˆ°è¾¾é¡ºåº
```

#### åæœ
- **æ•°æ®ä¸ä¸€è‡´**ï¼šä¸åŒèŠ‚ç‚¹å¯èƒ½æœ‰ä¸åŒçš„æ•°æ®
- **æ— æ³•æ¢å¤**ï¼šæ²¡æœ‰æœºåˆ¶æ£€æµ‹æˆ–ä¿®å¤ä¸ä¸€è‡´
- **ç”¨æˆ·æ•°æ®ä¸¢å¤±**ï¼šååˆ°è¾¾çš„å†™å…¥ä¼šè¦†ç›–å…ˆåˆ°è¾¾çš„

### 2ï¸âƒ£ **äº‹åŠ¡å®Œæ•´æ€§é—®é¢˜**

#### é—®é¢˜åœºæ™¯
```sql
-- è®¾å¤‡ A æ‰§è¡Œäº‹åŠ¡
BEGIN TRANSACTION;
INSERT INTO works (id, title) VALUES ('work1', 'ä½œå“1');
INSERT INTO chapters (id, work_id, title) VALUES ('ch1', 'work1', 'ç« èŠ‚1');
COMMIT;

-- P2P å¹¿æ’­ï¼šæ¯æ¡ SQL ç‹¬ç«‹å‘é€
å¹¿æ’­1: BEGIN TRANSACTION
å¹¿æ’­2: INSERT INTO works...
å¹¿æ’­3: INSERT INTO chapters...  -- ğŸš¨ å¯èƒ½å…ˆåˆ°è¾¾ï¼
å¹¿æ’­4: COMMIT
```

#### è¯æ®
```go
// æºç ä¸­æ²¡æœ‰äº‹åŠ¡è¾¹ç•Œä¿æŠ¤
p2pPubSub.Outbound <- sql  // æ¯æ¡ SQL ç‹¬ç«‹å¹¿æ’­
// æ²¡æœ‰äº‹åŠ¡ID
// æ²¡æœ‰æ‰¹å¤„ç†
// æ²¡æœ‰é¡ºåºä¿è¯
```

#### åæœ
- **å¤–é”®çº¦æŸå¤±è´¥**ï¼šchapters çš„ INSERT å¯èƒ½åœ¨ works INSERT ä¹‹å‰åˆ°è¾¾
- **æ•°æ®å®Œæ•´æ€§ç ´å**ï¼šäº‹åŠ¡çš„åŸå­æ€§æ— æ³•ä¿è¯
- **å­¤å„¿è®°å½•**ï¼šROLLBACK æ— æ³•æ­£ç¡®ä¼ æ’­

### 3ï¸âƒ£ **è‡ªå¢ ID å†²çª**

#### é—®é¢˜
```sql
-- è®¾å¤‡ A å’Œè®¾å¤‡ B åŒæ—¶æ’å…¥
è®¾å¤‡ A: INSERT INTO chapters (work_id, title) VALUES (1, 'ç« èŠ‚A');
è®¾å¤‡ B: INSERT INTO chapters (work_id, title) VALUES (1, 'ç« èŠ‚B');

-- å¦‚æœä½¿ç”¨ AUTOINCREMENT
è®¾å¤‡ A: ç”Ÿæˆ ID = 1
è®¾å¤‡ B: ä¹Ÿç”Ÿæˆ ID = 1  -- ğŸš¨ å†²çªï¼

-- å½“åŒæ­¥å
è®¾å¤‡ A æ‰§è¡Œè®¾å¤‡ B çš„ INSERT: INSERT INTO chapters (id, ...) VALUES (1, ...)
â†’ ä¸»é”®å†²çªï¼
```

#### è§£å†³æ–¹æ¡ˆï¼ˆæ‚¨å·²ä½¿ç”¨ï¼‰
- âœ… æ‚¨ä½¿ç”¨ ULIDï¼šä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜
- âš ï¸ ä½† IceFireDB-SQLite æ–‡æ¡£æ²¡æœ‰æåŠè¿™ä¸ªé—®é¢˜

### 4ï¸âƒ£ **ç½‘ç»œåˆ†åŒºï¼ˆSplit-Brainï¼‰é—®é¢˜**

#### åœºæ™¯
```
          Internet
             |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    |                 |
è®¾å¤‡ A            è®¾å¤‡ B, C, D
(ç¦»çº¿1å°æ—¶)      (ç»§ç»­åä½œ)

ç¦»çº¿æœŸé—´ï¼š
- A åˆ›å»ºäº†ç« èŠ‚ X
- B åˆ›å»ºäº†ç« èŠ‚ Y
- C ä¿®æ”¹äº†ç« èŠ‚ Z
- D åˆ é™¤äº†ç« èŠ‚ W

é‡æ–°è¿æ¥åï¼š
- æ²¡æœ‰å†²çªè§£å†³æœºåˆ¶
- åˆ é™¤æ“ä½œå¯èƒ½è¦†ç›–ä¿®æ”¹
- æ•°æ®çŠ¶æ€æ··ä¹±
```

#### IceFireDB çš„å¤„ç†
```go
// æºç ä¸­æ²¡æœ‰ç½‘ç»œåˆ†åŒºå¤„ç†
// æ²¡æœ‰ç‰ˆæœ¬å‘é‡ï¼ˆVersion Vectorsï¼‰
// æ²¡æœ‰å› æœé¡ºåºè·Ÿè¸ª
// é‡æ–°è¿æ¥åï¼šæ¶ˆæ¯ç»§ç»­æŒ‰åˆ°è¾¾é¡ºåºæ‰§è¡Œ
```

### 5ï¸âƒ£ **SQL æ³¨å…¥é£é™©ï¼ˆç†è®ºä¸Šï¼‰**

#### é—®é¢˜
```go
// P2P æ¶ˆæ¯æ˜¯çº¯æ–‡æœ¬ SQL
case s := <-p2pPubSub.Inbound:
    db.Exec(s.Message)  // ç›´æ¥æ‰§è¡Œæ¥æ”¶åˆ°çš„ SQL
```

#### é£é™©
- æ¶æ„èŠ‚ç‚¹å¯ä»¥å¹¿æ’­ä»»æ„ SQL
- æ²¡æœ‰ SQL éªŒè¯
- æ²¡æœ‰è®¿é—®æ§åˆ¶ï¼ˆåœ¨ P2P å±‚é¢ï¼‰

#### ç¼“è§£æªæ–½
- libp2p æœ‰ä¼ è¾“åŠ å¯†
- éœ€è¦åœ¨åŒä¸€ä¸ªæœåŠ¡ topic
- ä½†ä»ç„¶æ˜¯ä¿¡ä»»æ¨¡å‹è€ŒééªŒè¯æ¨¡å‹

### 6ï¸âƒ£ **æ€§èƒ½é—®é¢˜**

#### é—®é¢˜è¡¨ç°
```go
// æ¯ä¸ª DML æ“ä½œéƒ½å¹¿æ’­
for _, v := range DMLSQL {
    if strings.HasPrefix(prefix, v) {
        // æœ¬åœ°æ‰§è¡Œ
        result, err := db.Exec(sql)
        // å¹¿æ’­ç»™æ‰€æœ‰èŠ‚ç‚¹
        p2pPubSub.Outbound <- sql  
    }
}
```

#### åæœ
- **ç½‘ç»œæµé‡çº¿æ€§å¢é•¿**ï¼šN ä¸ªèŠ‚ç‚¹ = N å€æµé‡
- **å»¶è¿Ÿç´¯ç§¯**ï¼šæ¯æ¬¡ä¿å­˜éœ€è¦ç­‰å¾… P2P å¹¿æ’­
- **ä¸é€‚åˆé«˜é¢‘å†™å…¥**ï¼šå®æ—¶ç¼–è¾‘ä¼šäº§ç”Ÿå¤§é‡å¹¿æ’­

#### æµ‹ç®—ï¼ˆå‡è®¾ï¼‰
```
åœºæ™¯ï¼š3 ä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘ï¼Œæ¯åˆ†é’Ÿä¿å­˜ 1 æ¬¡
- æ¯æ¬¡ä¿å­˜ï¼š1 ä¸ª UPDATE è¯­å¥ â‰ˆ 1KB
- æ¯åˆ†é’Ÿï¼š3 æ¬¡ä¿å­˜
- æ¯ä¸ªèŠ‚ç‚¹æ¥æ”¶ï¼š2 æ¬¡å¹¿æ’­ï¼ˆå…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹ï¼‰
- æ€»æµé‡/åˆ†é’Ÿï¼š3 * 2 * 1KB = 6KB

å¦‚æœæ˜¯ Yjs ç²’åº¦çš„åŒæ­¥ï¼ˆæ¯ç§’æ•°åæ¬¡ï¼‰ï¼š
- æ€»æµé‡/åˆ†é’Ÿï¼š60 * 3 * 2 * 1KB = 360KB
- ä¸å¯è¡Œï¼
```

### 7ï¸âƒ£ **DELETE æ“ä½œçš„ä¸å¯æ¢å¤æ€§**

#### åœºæ™¯
```sql
-- è®¾å¤‡ A (ç¦»çº¿)
ç”¨æˆ·ç¼–è¾‘ç« èŠ‚ 123

-- è®¾å¤‡ B (åœ¨çº¿)
DELETE FROM chapters WHERE id='123';

-- è®¾å¤‡ A é‡æ–°ä¸Šçº¿
-- å®ƒçš„ä¿®æ”¹åŸºäºå·²åˆ é™¤çš„ç« èŠ‚
UPDATE chapters SET content='...' WHERE id='123';
-- è¿™ä¸ª UPDATE ä¼šå¤±è´¥ï¼Œä½†ç”¨æˆ·çš„ç¼–è¾‘ä¸¢å¤±äº†
```

#### IceFireDB çš„å¤„ç†
```go
// æ²¡æœ‰ä»»ä½•å¤„ç†
// DELETE å’Œ UPDATE æŒ‰åˆ°è¾¾é¡ºåºæ‰§è¡Œ
// æ²¡æœ‰æ’¤é”€æœºåˆ¶
```

---

## ğŸ†š ä¸æ‚¨å½“å‰éœ€æ±‚çš„å¯¹æ¯”

### æ‚¨çš„ä½¿ç”¨åœºæ™¯
```typescript
// ç¼–è¾‘æµç¨‹
ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£ (Yjs å®æ—¶ååŒ)
  â†“
ç‚¹å‡»"ä¿å­˜"
  â†“
Prisma æ‰§è¡Œ SQL
  â†“
IceFireDB-SQLite P2P åŒæ­¥  // ğŸš¨ é—®é¢˜é›†ä¸­åœ¨è¿™ä¸€å±‚
  â†“
å…¶ä»–è®¾å¤‡æ•°æ®åº“æ›´æ–°
```

### æ ¸å¿ƒçŸ›ç›¾

| éœ€æ±‚ | IceFireDB-SQLite æä¾› |
|------|---------------------|
| å†²çªè§£å†³ | âŒ æ—  |
| äº‹åŠ¡å®Œæ•´æ€§ | âŒ æ— ä¿è¯ |
| å› æœä¸€è‡´æ€§ | âŒ æ—  |
| ç¦»çº¿æ”¯æŒ | âš ï¸ æœ‰é™ï¼ˆé‡è¿åæ··ä¹±ï¼‰ |
| åˆ é™¤å®‰å…¨ | âŒ æ— ä¿æŠ¤ |
| ç‰ˆæœ¬æ§åˆ¶ | âŒ æ—  |

---

## ğŸ“Š ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

### IceFireDB-SQLite çš„å®šä½

æŸ¥çœ‹å…¶ä»–ç»„ä»¶å‘ç°ï¼š
```
IceFireDB é¡¹ç›®:
â”œâ”€â”€ IceFireDB-SQLite    (ç®€å•çš„ SQL å¹¿æ’­ï¼Œé€‚åˆè¯»å¤šå†™å°‘)
â”œâ”€â”€ IceFireDB-SQLProxy  (MySQL ä»£ç†ï¼Œç±»ä¼¼æ¶æ„)
â”œâ”€â”€ IceFireDB-PubSub    (æ¶ˆæ¯é˜Ÿåˆ—)
â””â”€â”€ driver/crdt/        (CRDT é©±åŠ¨ï¼ä½†åªç”¨äº KV å­˜å‚¨)
```

**å…³é”®å‘ç°**ï¼šIceFireDB æœ¬èº«æœ‰ CRDT å®ç°ï¼Œä½†**åªç”¨äº KV å­˜å‚¨ï¼Œä¸ç”¨äº SQL å±‚ï¼**

```go
// driver/crdt/db.go
func (db *DB) Put(key []byte, value []byte) error {
    return db.db.CRDTPut(key, value)  // è¿™é‡Œæœ‰ CRDT
}

// ä½†æ˜¯ IceFireDB-SQLite ä¸ä½¿ç”¨è¿™ä¸ªï¼
```

### æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šElectricSQLï¼ˆå¼ºçƒˆæ¨èï¼‰â­â­â­â­â­

```typescript
// æ¶æ„
PostgreSQL (ä¸­å¤®æœåŠ¡å™¨ï¼Œå¯é€‰)
    â†•ï¸
ElectricSQL Sync Engine (CRDT + CRDTs)
    â†•ï¸
æœ¬åœ° SQLite + Reactive Queries
    â†•ï¸
Vue 3 åº”ç”¨

// ä¼˜åŠ¿
âœ… åŸºäº CRDT çš„å†²çªè§£å†³
âœ… ç¦»çº¿ä¼˜å…ˆè®¾è®¡
âœ… å®æ—¶æŸ¥è¯¢å“åº”
âœ… è‡ªåŠ¨å¤„ç†ç½‘ç»œåˆ†åŒº
âœ… ç”Ÿäº§çº§ç¨³å®šæ€§
```

**å…³é”®ç‰¹æ€§**ï¼š
```sql
-- ElectricSQL è‡ªåŠ¨å¤„ç†
CREATE TABLE contents (
  id TEXT PRIMARY KEY,
  content TEXT,
  _version INTEGER,      -- è‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶
  _updated_at TIMESTAMP  -- è‡ªåŠ¨æ—¶é—´æˆ³
);

-- å†²çªè‡ªåŠ¨è§£å†³ï¼ˆLWW æˆ– customï¼‰
```

#### æ–¹æ¡ˆ Bï¼šRxDB + CouchDB åŒæ­¥

```typescript
// æ¶æ„
RxDB (æµè§ˆå™¨ç«¯ï¼ŒCRDT)
    â†•ï¸ 
CouchDB å¤åˆ¶åè®®
    â†•ï¸
PouchDB Server / CouchDB

// ä¼˜åŠ¿
âœ… æˆç†Ÿçš„å†²çªè§£å†³
âœ… åŒå‘åŒæ­¥
âœ… ç¦»çº¿ä¼˜å…ˆ
âœ… çµæ´»çš„å¤åˆ¶ç­–ç•¥
```

#### æ–¹æ¡ˆ Cï¼šè‡ªå®šä¹‰ CRDT å±‚ï¼ˆæœ€çµæ´»ï¼‰

```typescript
// æ¶æ„è®¾è®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼–è¾‘å±‚ï¼šYjs (CRDT)                   â”‚
â”‚ - å®æ—¶ååŒç¼–è¾‘                       â”‚
â”‚ - è‡ªåŠ¨å†²çªè§£å†³                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ä¿å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…ƒæ•°æ®å±‚ï¼šè‡ªå®šä¹‰ CRDT                 â”‚
â”‚ - Work/Chapter ç»“æ„                 â”‚
â”‚ - Automerge æˆ– Yjs.Map               â”‚
â”‚ - ç‰ˆæœ¬å‘é‡è¿½è¸ª                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ è¾“å±‚ï¼šlibp2p                       â”‚
â”‚ - WebRTC/WebSocket                  â”‚
â”‚ - å¢é‡åŒæ­¥                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨å±‚ï¼šSQLite                       â”‚
â”‚ - å¿«ç…§å­˜å‚¨                          â”‚
â”‚ - å˜æ›´æ—¥å¿—                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨æ§åˆ¶å†²çªè§£å†³ç­–ç•¥
- âœ… ä¸ç°æœ‰ Yjs æ¶æ„ä¸€è‡´
- âœ… å¯ä»¥æ¸è¿›å¼å®ç°
- âœ… é’ˆå¯¹å†™ä½œåœºæ™¯ä¼˜åŒ–

---

## ğŸ¯ å…·ä½“å»ºè®®

### çŸ­æœŸæ–¹æ¡ˆï¼ˆ1å‘¨å†…ï¼‰ï¼šä¿æŒç°çŠ¶ + å¢å¼º

```typescript
// å½“å‰æ¶æ„å¾ˆå¥½ï¼Œåªéœ€åŠ å¼ºä¸€ç‚¹
class WorkSyncService {
  // 1. åœ¨ä¿å­˜æ—¶ç”Ÿæˆå˜æ›´æ—¥å¿—
  async saveWork(work: Work) {
    const changeLog = {
      id: ulid(),
      workId: work.id,
      type: 'work_update',
      changes: diff(oldWork, work),
      timestamp: Date.now(),
      userId: currentUser.id,
      version: work.version + 1
    };
    
    // 2. ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    await prisma.work.update({...});
    await prisma.changeLog.create(changeLog);
    
    // 3. é€šè¿‡ WebSocket å¹¿æ’­å˜æ›´æ—¥å¿—ï¼ˆä¸æ˜¯ SQLï¼ï¼‰
    wsClient.broadcast(changeLog);
  }
  
  // 4. æ¥æ”¶å˜æ›´æ—¶ï¼Œåº”ç”¨è¡¥ä¸
  async applyChange(changeLog: ChangeLog) {
    const currentWork = await prisma.work.findUnique(...);
    
    // ç‰ˆæœ¬æ£€æŸ¥
    if (changeLog.version <= currentWork.version) {
      return; // æ—§ç‰ˆæœ¬ï¼Œå¿½ç•¥
    }
    
    // åº”ç”¨å˜æ›´
    const newWork = patch(currentWork, changeLog.changes);
    await prisma.work.update(newWork);
  }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… 1å‘¨å†…å¯å®ç°
- âœ… æœ€å°æ”¹åŠ¨
- âœ… åŸºæœ¬çš„å†²çªé¿å…
- âœ… ä¿ç•™ç°æœ‰æ¶æ„

### ä¸­æœŸæ–¹æ¡ˆï¼ˆ1ä¸ªæœˆå†…ï¼‰ï¼šé›†æˆ Automerge

```typescript
import * as Automerge from '@automerge/automerge';

class CRDTWorkStore {
  private doc: Automerge.Doc<WorkState>;
  
  async init() {
    // ä» SQLite åŠ è½½
    const works = await prisma.work.findMany();
    this.doc = Automerge.from({ works });
  }
  
  updateWork(workId: string, changes: Partial<Work>) {
    this.doc = Automerge.change(this.doc, doc => {
      const work = doc.works.find(w => w.id === workId);
      Object.assign(work, changes);
    });
    
    // æŒä¹…åŒ–åˆ° SQLite
    this.persistToSQLite();
    
    // P2P åŒæ­¥ï¼ˆå‘é€å¢é‡ï¼‰
    const syncMessage = Automerge.getLastLocalChange(this.doc);
    p2pNetwork.broadcast(syncMessage);
  }
  
  receiveChange(change: Uint8Array) {
    this.doc = Automerge.applyChanges(this.doc, [change]);
    this.persistToSQLite();
  }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸“ä¸šçš„ CRDT å®ç°
- âœ… è‡ªåŠ¨å†²çªè§£å†³
- âœ… ä¸ Yjs å…¼å®¹ï¼ˆéƒ½æ˜¯ CRDTï¼‰
- âœ… ç¦»çº¿ä¼˜å…ˆ

### é•¿æœŸæ–¹æ¡ˆï¼ˆ3ä¸ªæœˆï¼‰ï¼šå…¨é¢ ElectricSQL

```typescript
// 1. éƒ¨ç½² ElectricSQL æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼Œå¯ä»¥çº¯ P2Pï¼‰
// 2. é›†æˆå®¢æˆ·ç«¯
import { electrify } from 'electric-sql';

const electric = await electrify(
  await initSQLite(),
  schema,
  config
);

// 3. æ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨åŒæ­¥
const { results } = await electric.db.works.liveMany();
// 4. ä¿®æ”¹è‡ªåŠ¨ä¼ æ’­
await electric.db.works.update({
  where: { id: workId },
  data: { title: newTitle }
});
// â† è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡ï¼
```

---

## ğŸ’° æˆæœ¬æ•ˆç›Šåˆ†æ

| æ–¹æ¡ˆ | å¼€å‘æˆæœ¬ | ç»´æŠ¤æˆæœ¬ | å¯é æ€§ | ç”¨æˆ·ä½“éªŒ |
|------|---------|---------|--------|---------|
| **IceFireDB-SQLite** | ä½ï¼ˆ2å¤©ï¼‰ | é«˜ï¼ˆé¢‘ç¹bugï¼‰ | â­ | â­â­ |
| **çŸ­æœŸæ–¹æ¡ˆï¼ˆæ—¥å¿—ï¼‰** | ä½ï¼ˆ1å‘¨ï¼‰ | ä¸­ | â­â­â­ | â­â­â­ |
| **Automerge** | ä¸­ï¼ˆ1æœˆï¼‰ | ä½ | â­â­â­â­ | â­â­â­â­ |
| **ElectricSQL** | ä¸­ï¼ˆ1æœˆï¼‰ | å¾ˆä½ | â­â­â­â­â­ | â­â­â­â­â­ |

---

## ğŸš¦ æœ€ç»ˆå»ºè®®

### âŒ ä¸è¦ä½¿ç”¨ IceFireDB-SQLiteï¼Œå› ä¸ºï¼š

1. **æ•°æ®å®‰å…¨é£é™©**ï¼šæ— å†²çªè§£å†³ = ç”¨æˆ·æ•°æ®å¯èƒ½ä¸¢å¤±
2. **ä¸å¯é¢„æµ‹æ€§**ï¼šä¾èµ–ç½‘ç»œå»¶è¿Ÿçš„ç»“æœæ˜¯ä¸ç¡®å®šçš„
3. **æŠ€æœ¯å€ºåŠ¡**ï¼šéœ€è¦è‡ªå·±å®ç°æ‰€æœ‰å†²çªå¤„ç†
4. **ç»´æŠ¤å™©æ¢¦**ï¼šç”¨æˆ·æŠ¥å‘Šçš„ bug æ— æ³•é‡ç°

### âœ… æ¨èæ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

1. **ç«‹å³ï¼ˆæœ¬å‘¨ï¼‰**ï¼š
   - å®ç°å˜æ›´æ—¥å¿— + ç‰ˆæœ¬å·
   - é€šè¿‡ WebSocket åŒæ­¥å˜æ›´ï¼ˆä¸æ˜¯SQLï¼‰
   - ç®€å•çš„ LWW (Last-Write-Wins) ç­–ç•¥

2. **çŸ­æœŸï¼ˆ1ä¸ªæœˆï¼‰**ï¼š
   - é›†æˆ Automerge å¤„ç†å…ƒæ•°æ®
   - Yjs å¤„ç†æ–‡æ¡£å†…å®¹
   - ç»Ÿä¸€çš„ CRDT æ¶æ„

3. **é•¿æœŸï¼ˆ3ä¸ªæœˆï¼‰**ï¼š
   - è¯„ä¼° ElectricSQL
   - æˆ–å®Œå–„ Automerge æ–¹æ¡ˆ
   - ç”Ÿäº§çº§éƒ¨ç½²

### ğŸ—ï¸ å…·ä½“å®æ–½è·¯çº¿

```
Week 1-2: å®ç°å˜æ›´æ—¥å¿—ç³»ç»Ÿ
  â”œâ”€â”€ æ•°æ®åº“ schema æ·»åŠ  change_logs è¡¨
  â”œâ”€â”€ ç‰ˆæœ¬å·è¿½è¸ª
  â”œâ”€â”€ WebSocket åŒæ­¥æœåŠ¡
  â””â”€â”€ åŸºç¡€å†²çªæ£€æµ‹

Week 3-4: æµ‹è¯•å’Œä¼˜åŒ–
  â”œâ”€â”€ å¤šè®¾å¤‡æµ‹è¯•
  â”œâ”€â”€ ç½‘ç»œåˆ†åŒºæ¨¡æ‹Ÿ
  â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–
  â””â”€â”€ ç”¨æˆ·åé¦ˆ

Month 2: Automerge é›†æˆ
  â”œâ”€â”€ Work/Chapter å…ƒæ•°æ® CRDT åŒ–
  â”œâ”€â”€ ä¸ Yjs é›†æˆ
  â”œâ”€â”€ æŒä¹…åŒ–ç­–ç•¥
  â””â”€â”€ å¢é‡åŒæ­¥ä¼˜åŒ–

Month 3: ç”Ÿäº§åŒ–
  â”œâ”€â”€ ç›‘æ§å’Œè¯Šæ–­
  â”œâ”€â”€ æ•°æ®è¿ç§»å·¥å…·
  â”œâ”€â”€ å†²çªè§£å†³ UI
  â””â”€â”€ æ–‡æ¡£å’ŒåŸ¹è®­
```

---

## ğŸ“š æŠ€æœ¯å‚è€ƒ

### å¿…è¯»è®ºæ–‡/æ–‡æ¡£
1. [CRDT: Conflict-free Replicated Data Types](https://crdt.tech/)
2. [Automerge è®ºæ–‡](https://arxiv.org/abs/1608.03960)
3. [ElectricSQL æ–‡æ¡£](https://electric-sql.com/docs)
4. [Local-First Software](https://www.inkandswitch.com/local-first/)

### å¼€æºé¡¹ç›®å‚è€ƒ
1. [Automerge](https://github.com/automerge/automerge)
2. [Y.js](https://github.com/yjs/yjs) ï¼ˆæ‚¨å·²ä½¿ç”¨ï¼‰
3. [ElectricSQL](https://github.com/electric-sql/electric)
4. [RxDB](https://github.com/pubkey/rxdb)

---

## ğŸ”’ æœ€åçš„è¯

IceFireDB-SQLite æ˜¯ä¸€ä¸ª**å®éªŒæ€§é¡¹ç›®**ï¼Œé€‚åˆï¼š
- âœ… å­¦ä¹  P2P æŠ€æœ¯
- âœ… åŸå‹éªŒè¯
- âœ… è¯»å¤šå†™å°‘åœºæ™¯ï¼ˆå¦‚å†…å®¹åˆ†å‘ï¼‰

**ä¸é€‚åˆ**ï¼š
- âŒ ååŒç¼–è¾‘
- âŒ ç”Ÿäº§ç¯å¢ƒ
- âŒ æ•°æ®å…³é”®åº”ç”¨

æ‚¨çš„å†™ä½œè½¯ä»¶æ˜¯**æ•°æ®å…³é”®åº”ç”¨**ï¼Œç”¨æˆ·çš„æ–‡å­—æ˜¯ä»–ä»¬çš„å¿ƒè¡€ã€‚é€‰æ‹©ä¸€ä¸ª**ç»è¿‡éªŒè¯ã€æœ‰å†²çªè§£å†³æœºåˆ¶**çš„æ–¹æ¡ˆéå¸¸é‡è¦ã€‚

å»ºè®®ï¼š**å…ˆå®ç°å˜æ›´æ—¥å¿—æ–¹æ¡ˆï¼ˆ1-2å‘¨ï¼‰ï¼Œç„¶åè¯„ä¼° Automerge æˆ– ElectricSQL**ã€‚
