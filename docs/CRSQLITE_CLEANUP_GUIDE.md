# CR-SQLite å˜æ›´æ—¥å¿—æ¸…ç†æŒ‡å—

## ğŸ“š èƒŒæ™¯

### é—®é¢˜ï¼šå˜æ›´æ—¥å¿—ç´¯ç§¯

CR-SQLite ä¼šè®°å½•æ¯æ¬¡æ•°æ®åº“æ›´æ–°åˆ° `crsql_changes` è¡¨ä¸­ï¼Œç”¨äº P2P åŒæ­¥ã€‚ä½†è¿™ä¼šå¯¼è‡´ï¼š

```
åœºæ™¯ï¼š2äººåä½œï¼Œ10åˆ†é’Ÿå†… 100 æ¬¡ç¼–è¾‘
â”œâ”€ ç”Ÿæˆ 100 æ¡å˜æ›´è®°å½•
â”œâ”€ æ¯æ¡çº¦ 5KBï¼ˆåŒ…å«å†…å®¹ï¼‰
â””â”€ æ€»è®¡ï¼š~510 KB

é—®é¢˜ï¼š
1. æœ€ç»ˆåªéœ€è¦æœ€åä¸€ä¸ªç‰ˆæœ¬
2. ä¸­é—´çš„ 99 ä¸ªç‰ˆæœ¬æ˜¯å†—ä½™çš„
3. é•¿æœŸç´¯ç§¯ä¼šå¯¼è‡´æ•°æ®åº“è†¨èƒ€
```

### è§£å†³æ–¹æ¡ˆï¼šå®šæœŸæ¸…ç†

ä¿ç•™æœ€è¿‘çš„å˜æ›´ï¼ˆç”¨äºåŒæ­¥ï¼‰ï¼Œåˆ é™¤æ—§çš„å˜æ›´ï¼ˆå·²åŒæ­¥å®Œæˆï¼‰ã€‚

---

## ğŸ¯ æ¸…ç†ç­–ç•¥

### 1. **è‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰**

```typescript
import { DatabaseManager } from './core/db-manager';
import { SyncCoordinator } from './core/sync-coordinator';

// åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†å™¨
const dbManager = new DatabaseManager({
  dbPath: '/path/to/database.db',
  enableWal: true
});

await dbManager.initialize();

// åˆ›å»ºåŒæ­¥åè°ƒå™¨ï¼ˆè‡ªåŠ¨æ¸…ç†å·²å¯ç”¨ï¼‰
const syncCoordinator = new SyncCoordinator(dbManager);

// å¯åŠ¨ï¼ˆåŒ…å«è‡ªåŠ¨æ¸…ç†ï¼‰
syncCoordinator.start();

// é…ç½®è¯´æ˜ï¼š
// - retentionDays: 7        ä¿ç•™æœ€è¿‘ 7 å¤©çš„å˜æ›´
// - minChangesToKeep: 100   è‡³å°‘ä¿ç•™ 100 æ¡å˜æ›´
// - compactAfterSync: true  æ¯æ¬¡åŒæ­¥åè‡ªåŠ¨å‹ç¼©
// - scheduledCleanupIntervalMs: 3600000  æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡
```

### 2. **æ‰‹åŠ¨æ¸…ç†**

```typescript
// åœºæ™¯ Aï¼šåŒæ­¥åç«‹å³æ¸…ç†
await syncCoordinator.manualSync();
await syncCoordinator.manualCleanup();

// åœºæ™¯ Bï¼šå®šæœŸæ¸…ç†ï¼ˆå¦‚å‡Œæ™¨ 3 ç‚¹ï¼‰
const cleanupTask = cron.schedule('0 3 * * *', () => {
  syncCoordinator.manualCleanup();
});

// åœºæ™¯ Cï¼šè¾¾åˆ°é˜ˆå€¼åæ¸…ç†
const stats = dbManager.getChangesStats();
if (stats.totalChanges > 10000) {
  await syncCoordinator.manualCleanup();
}
```

### 3. **ç²¾ç»†æ§åˆ¶**

```typescript
// ç›´æ¥ä½¿ç”¨ DatabaseManager çš„æ¸…ç†æ–¹æ³•
import { dbManager } from './core/db-manager';

// è·å–ç»Ÿè®¡ä¿¡æ¯
const stats = dbManager.getChangesStats();
console.log('å˜æ›´æ—¥å¿—ç»Ÿè®¡:', {
  æ€»è®°å½•æ•°: stats.totalChanges,
  æœ€æ—§ç‰ˆæœ¬: stats.oldestVersion,
  æœ€æ–°ç‰ˆæœ¬: stats.newestVersion,
  ä¼°ç®—å¤§å°: `${(stats.estimatedSize / 1024 / 1024).toFixed(2)} MB`
});

// æ¸…ç†æŒ‡å®šç‰ˆæœ¬ä¹‹å‰çš„æ‰€æœ‰å˜æ›´
const cutoffVersion = stats.newestVersion - 1000; // ä¿ç•™æœ€è¿‘ 1000 ä¸ªç‰ˆæœ¬
dbManager.compactChanges(cutoffVersion);
```

---

## ğŸ”„ å®Œæ•´çš„åŒæ­¥ + æ¸…ç†æµç¨‹

### ä¸‰å±‚æ¶æ„

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç¬¬ 1 å±‚ï¼šå®æ—¶åä½œ                        â”‚
â”‚  Yjs WebRTC (æ¯«ç§’çº§)                                    â”‚
â”‚  - ç”¨æˆ·ç¼–è¾‘ â†’ å®æ—¶åŒæ­¥ç»™å…¶ä»–åœ¨çº¿ç”¨æˆ·                     â”‚
â”‚  - å»¶è¿Ÿ: < 100ms                                        â”‚
â”‚  - æ•°æ®é‡: æ¯æ¬¡ç¼–è¾‘ ~100-500 bytes                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ 5 ç§’é˜²æŠ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç¬¬ 2 å±‚ï¼šæœ¬åœ°æŒä¹…åŒ–                      â”‚
â”‚  SQLite å¿«ç…§ (ç§’çº§)                                     â”‚
â”‚  - 5 ç§’æ— æ“ä½œ â†’ ä¿å­˜å¿«ç…§åˆ° SQLite                       â”‚
â”‚  - CR-SQLite è‡ªåŠ¨è®°å½•å˜æ›´åˆ° crsql_changes è¡¨           â”‚
â”‚  - å¼€é”€: æ¯æ¬¡ ~0.01msï¼ˆè®°å½•å˜æ›´ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ ç©ºé—² 1 åˆ†é’Ÿ / å®šæ—¶ 5 åˆ†é’Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç¬¬ 3 å±‚ï¼šè®¾å¤‡é—´åŒæ­¥                      â”‚
â”‚  CR-SQLite P2P (åˆ†é’Ÿçº§)                                â”‚
â”‚  - ç©ºé—² 1 åˆ†é’Ÿå â†’ æ‰¹é‡åŒæ­¥æ‰€æœ‰ç´¯ç§¯å˜æ›´                 â”‚
â”‚  - æˆ–å®šæ—¶ 5 åˆ†é’Ÿå¼ºåˆ¶åŒæ­¥                                â”‚
â”‚  - åŒæ­¥åæ¸…ç†æ—§å˜æ›´ (å¯é€‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ åŒæ­¥å / æ¯å°æ—¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ¸…ç†å±‚ï¼šå˜æ›´æ—¥å¿—å‹ç¼©                     â”‚
â”‚  - åˆ é™¤å·²åŒæ­¥çš„æ—§å˜æ›´                                   â”‚
â”‚  - ä¿ç•™æœ€è¿‘ 7 å¤© æˆ– è‡³å°‘ 100 æ¡                         â”‚
â”‚  - è¿è¡Œ VACUUM å›æ”¶ç£ç›˜ç©ºé—´                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¤ºä¾‹ä»£ç 

```typescript
// main.ts æˆ–åº”ç”¨å…¥å£

import { DatabaseManager } from './core/db-manager';
import { SyncCoordinator } from './core/sync-coordinator';

async function initializeSync() {
  // 1ï¸âƒ£ åˆå§‹åŒ–æ•°æ®åº“
  const dbManager = new DatabaseManager({
    dbPath: app.getPath('userData') + '/gestell.db',
    enableWal: true
  });

  await dbManager.initialize();

  // 2ï¸âƒ£ åˆ›å»ºåŒæ­¥åè°ƒå™¨
  const syncCoordinator = new SyncCoordinator(dbManager);

  // 3ï¸âƒ£ å¯åŠ¨è‡ªåŠ¨åŒæ­¥å’Œæ¸…ç†
  syncCoordinator.start();

  // 4ï¸âƒ£ ç›‘å¬ç¼–è¾‘äº‹ä»¶ï¼ˆç”± WritingView è§¦å‘ï¼‰
  ipcMain.on('content:edited', () => {
    syncCoordinator.notifyEdit();
  });

  ipcMain.on('content:snapshot-saved', () => {
    syncCoordinator.notifySnapshotSaved();
  });

  // 5ï¸âƒ£ æä¾›æ‰‹åŠ¨åŒæ­¥æ¥å£ï¼ˆå¯é€‰ï¼‰
  ipcMain.handle('sync:manual', async () => {
    await syncCoordinator.manualSync();
    return { success: true };
  });

  ipcMain.handle('sync:cleanup', async () => {
    await syncCoordinator.manualCleanup();
    return { success: true };
  });

  ipcMain.handle('sync:status', () => {
    return syncCoordinator.getStatus();
  });

  // 6ï¸âƒ£ åº”ç”¨é€€å‡ºæ—¶åœæ­¢
  app.on('before-quit', () => {
    syncCoordinator.stop();
    dbManager.close();
  });
}

initializeSync();
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼š2 äººåä½œï¼Œ10 åˆ†é’Ÿå†… 100 æ¬¡ç¼–è¾‘

#### âŒ ä¸æ¸…ç†ï¼ˆç´¯ç§¯é—®é¢˜ï¼‰

```
10 å¤©åï¼š
â”œâ”€ å˜æ›´è®°å½•ï¼š~14,400 æ¡ï¼ˆæ¯å¤© 10 åˆ†é’Ÿï¼Œ100 æ¬¡ç¼–è¾‘ï¼‰
â”œâ”€ å­˜å‚¨å ç”¨ï¼š~7.2 MB
â””â”€ æŸ¥è¯¢æ€§èƒ½ï¼šå˜æ…¢ï¼ˆéœ€è¦æ‰«æå¤§é‡è®°å½•ï¼‰
```

#### âœ… è‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰

```
ä»»ä½•æ—¶å€™ï¼š
â”œâ”€ å˜æ›´è®°å½•ï¼š< 1000 æ¡ï¼ˆä¿ç•™æœ€è¿‘çš„ï¼‰
â”œâ”€ å­˜å‚¨å ç”¨ï¼š< 0.5 MB
â””â”€ æŸ¥è¯¢æ€§èƒ½ï¼šå¿«é€Ÿ
```

---

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### 1. **ä½•æ—¶å¯ä»¥å®‰å…¨æ¸…ç†ï¼Ÿ**

âœ… å¯ä»¥æ¸…ç†ï¼š
- æ‰€æœ‰è®¾å¤‡éƒ½å·²åŒæ­¥å®Œæˆ
- å˜æ›´å·²ç»åœ¨æ‰€æœ‰èŠ‚ç‚¹åº”ç”¨
- ä¿ç•™äº†è¶³å¤Ÿçš„å†å²ç”¨äºæ–°è®¾å¤‡åŠ å…¥

âŒ ä¸èƒ½æ¸…ç†ï¼š
- æœ‰è®¾å¤‡é•¿æ—¶é—´ç¦»çº¿æœªåŒæ­¥
- æ­£åœ¨è¿›è¡ŒåŒæ­¥è¿‡ç¨‹ä¸­
- éœ€è¦å›æ»šåˆ°æ—§ç‰ˆæœ¬

### 2. **ä¿ç•™ç­–ç•¥å»ºè®®**

```typescript
// ä¿å®ˆç­–ç•¥ï¼ˆé€‚åˆå¤šè®¾å¤‡ã€ä¸ç¨³å®šç½‘ç»œï¼‰
{
  retentionDays: 30,      // ä¿ç•™ 30 å¤©
  minChangesToKeep: 500   // è‡³å°‘ 500 æ¡
}

// å¹³è¡¡ç­–ç•¥ï¼ˆæ¨èï¼‰
{
  retentionDays: 7,       // ä¿ç•™ 7 å¤©
  minChangesToKeep: 100   // è‡³å°‘ 100 æ¡
}

// æ¿€è¿›ç­–ç•¥ï¼ˆå•è®¾å¤‡æˆ–ç¨³å®šç½‘ç»œï¼‰
{
  retentionDays: 1,       // ä¿ç•™ 1 å¤©
  minChangesToKeep: 50    // è‡³å°‘ 50 æ¡
}
```

### 3. **æ¸…ç†å‰æ£€æŸ¥**

```typescript
async function safeCleanup() {
  // 1. æ£€æŸ¥æ‰€æœ‰è®¾å¤‡æ˜¯å¦åœ¨çº¿å¹¶å·²åŒæ­¥
  const allDevicesSynced = await checkAllDevicesSyncStatus();
  
  if (!allDevicesSynced) {
    console.warn('âš ï¸  æœ‰è®¾å¤‡æœªåŒæ­¥ï¼Œæ¨è¿Ÿæ¸…ç†');
    return;
  }

  // 2. æ‰§è¡Œæ¸…ç†
  await syncCoordinator.manualCleanup();
}
```

---

## ğŸ“ æ€»ç»“

### å…³é”®ç‚¹

1. âœ… **CR-SQLite è®°å½•å˜æ›´çš„å¼€é”€å¾ˆå°**ï¼ˆæ¯æ¬¡ ~0.01msï¼‰
2. âœ… **å˜æ›´è®°å½•å¯ä»¥å®šæœŸæ¸…ç†**ï¼ˆä¸ä¼šå½±å“å·²åŒæ­¥çš„æ•°æ®ï¼‰
3. âœ… **æ¨èç­–ç•¥**ï¼šä¿ç•™æœ€è¿‘ 7 å¤©æˆ–è‡³å°‘ 100 æ¡å˜æ›´
4. âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šåŒæ­¥åæˆ–æ¯å°æ—¶è‡ªåŠ¨è¿è¡Œ

### æœ€ä½³å®è·µ

```typescript
// åœ¨åº”ç”¨ä¸­å¯ç”¨è‡ªåŠ¨æ¸…ç†
const syncCoordinator = new SyncCoordinator(dbManager);
syncCoordinator.start();  // è‡ªåŠ¨å¤„ç†ä¸€åˆ‡ï¼

// ç›‘æ§å­˜å‚¨ä½¿ç”¨
setInterval(() => {
  const stats = dbManager.getChangesStats();
  console.log('å˜æ›´æ—¥å¿—å¤§å°:', 
    (stats.estimatedSize / 1024 / 1024).toFixed(2), 'MB'
  );
}, 60000);
```

### é¢„æœŸæ•ˆæœ

- ğŸ’¾ å­˜å‚¨å ç”¨ï¼šä¿æŒåœ¨ < 1 MB
- âš¡ æŸ¥è¯¢æ€§èƒ½ï¼šå§‹ç»ˆå¿«é€Ÿ
- ğŸ”„ åŒæ­¥æ•ˆç‡ï¼šåªä¼ è¾“å¿…è¦çš„å˜æ›´
- ğŸ¯ å¼€é”€ï¼šå‡ ä¹å¯ä»¥å¿½ç•¥
