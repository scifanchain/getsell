# å†…å®¹åˆ‡æ¢åŠ è½½é—®é¢˜ä¿®å¤æŠ¥å‘Š

> **é—®é¢˜**: ç‚¹å‡»ç« èŠ‚ç›®å½•ä¸­çš„å†…å®¹æ ‡é¢˜æ—¶ï¼Œå†…å®¹æ²¡æœ‰è¢«åŠ è½½æ¸²æŸ“åˆ°ç¼–è¾‘å™¨  
> **æ—¥æœŸ**: 2025-10-18

---

## ğŸ› é—®é¢˜ç°è±¡

ç”¨æˆ·ç‚¹å‡»ç« èŠ‚æ ‘ä¸­çš„å†…å®¹æ—¶ï¼Œç¼–è¾‘å™¨æ˜¾ç¤ºç©ºç™½æˆ–æ˜¾ç¤ºæ—§å†…å®¹ï¼Œæ–°å†…å®¹æ²¡æœ‰è¢«åŠ è½½ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜æ ¹æº

1. **Editor ç»„ä»¶ä¸å“åº” `props.modelValue` å˜åŒ–**
   - Editor åªåœ¨åˆå§‹åŒ–æ—¶è¯»å– `props.modelValue`
   - ä¹‹å `modelValue` å˜åŒ–ä¸ä¼šè§¦å‘ç¼–è¾‘å™¨å†…å®¹æ›´æ–°

2. **editorKey åœ¨æŸäº›æƒ…å†µä¸‹ä¸å˜**
   - å½“ä»åŒä¸€åä½œæ¨¡å¼ä¸‹çš„å†…å®¹ A åˆ‡æ¢åˆ°å†…å®¹ B
   - å¦‚æœ `currentContent` ä¸æ¸…ç©ºï¼Œ`editorKey` å§‹ç»ˆæ˜¯ `"A-id-collab"` â†’ `"B-id-collab"`
   - ä½†è¿™ä¼šå¯¼è‡´ Vue å¤ç”¨ç»„ä»¶ï¼Œä¸é‡æ–°æŒ‚è½½

3. **ä¹‹å‰çš„"è¿‡åº¦ä¼˜åŒ–"**
   - ä¸ºäº†é¿å… WebSocket é‡è¿ï¼Œå®Œå…¨ç¦æ­¢æ¸…ç©º `currentContent`
   - ä½†è¿™å¯¼è‡´å†…å®¹åˆ‡æ¢æ—¶ Editor ç»„ä»¶ä¸æ›´æ–°

### æŠ€æœ¯ç»†èŠ‚

**Vue çš„ key æœºåˆ¶**ï¼š
- å½“ `:key` å€¼å˜åŒ–æ—¶ï¼ŒVue ä¼šé”€æ¯æ—§ç»„ä»¶å¹¶åˆ›å»ºæ–°ç»„ä»¶
- å½“ `:key` å€¼ç›¸åŒæ—¶ï¼ŒVue ä¼šå¤ç”¨ç»„ä»¶ï¼ˆä¸é‡æ–°æŒ‚è½½ï¼‰

**editorKey è®¡ç®—é€»è¾‘**ï¼š
```typescript
const editorKey = computed(() => {
  const contentId = currentContent.value?.id ?? 'empty'
  const mode = isCollaborationActive.value ? 'collab' : 'solo'
  return `${contentId}-${mode}`
})
```

**é—®é¢˜åœºæ™¯**ï¼š
```
1. ç”¨æˆ·æŸ¥çœ‹å†…å®¹ A (editorKey = "A-id-collab")
2. ç”¨æˆ·ç‚¹å‡»å†…å®¹ B
3. å¦‚æœä¸æ¸…ç©º currentContentï¼š
   - currentContent ç›´æ¥ä» A å˜ä¸º B
   - editorKey ä» "A-id-collab" å˜ä¸º "B-id-collab"
   - Vue æ£€æµ‹åˆ° key å˜åŒ–ï¼Œä½†...
   - å®é™…ä¸Šä¸¤ä¸ª key éƒ½ä¸åŒï¼Œåº”è¯¥ä¼šé‡æ–°æŒ‚è½½
4. é—®é¢˜å¯èƒ½å‡ºåœ¨å¼‚æ­¥åŠ è½½è¿‡ç¨‹ä¸­...
```

å®é™…é—®é¢˜ï¼šåœ¨ä¹‹å‰çš„ä¿®å¤ä¸­ï¼Œæˆ‘ä»¬åˆ é™¤äº† `currentContent.value = null` è¿™è¡Œä»£ç ï¼Œä½†æ²¡æœ‰ `await nextTick()`ï¼Œå¯¼è‡´ Vue çš„å“åº”å¼æ›´æ–°ä¸å¤ŸåŠæ—¶ã€‚

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šå—æ§çš„ä¸´æ—¶æ¸…ç©º

**å…³é”®æ€è·¯**ï¼š
- âœ… åªåœ¨åˆ‡æ¢åˆ°**ä¸åŒå†…å®¹**æ—¶ä¸´æ—¶æ¸…ç©º
- âœ… ä½¿ç”¨ `await nextTick()` ç¡®ä¿ Vue æ›´æ–° DOM
- âœ… ç«‹å³åŠ è½½æ–°å†…å®¹
- âœ… è¿™æ · `editorKey` ä¼šç»å†ï¼š`old-id` â†’ `empty` â†’ `new-id`

**ä»£ç å®ç°**ï¼š

```typescript
const handleContentSelect = async (contentId: string) => {
  try {
    console.log('ğŸ” ç”¨æˆ·é€‰æ‹©å†…å®¹:', contentId)
    
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ä¸åŒçš„å†…å®¹
    const isDifferentContent = currentContent.value?.id !== contentId
    
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåªåœ¨åˆ‡æ¢åˆ°ä¸åŒå†…å®¹æ—¶ä¸´æ—¶æ¸…ç©º
    if (isDifferentContent && currentContent.value) {
      console.log('ğŸ”„ åˆ‡æ¢åˆ°ä¸åŒå†…å®¹ï¼Œä¸´æ—¶æ¸…ç©º currentContent')
      currentContent.value = null
      await nextTick() // âœ… ç­‰å¾… Vue æ›´æ–° DOMï¼Œç¡®ä¿ editorKey å˜ä¸º "empty"
    }
    
    // è®¾ç½®åŠ è½½çŠ¶æ€
    isLoadingContent.value = true
    
    // åŠ è½½æ–°å†…å®¹
    const content = await contentService.fetchContent(contentId, userId)
    if (!content) {
      showNotification('æœªæ‰¾åˆ°è¯¥å†…å®¹', 'error')
      isLoadingContent.value = false
      return
    }
    
    // è®¾ç½®æ–°å†…å®¹ï¼ˆeditorKey å˜ä¸º "new-id"ï¼‰
    currentContent.value = content
    
    // ... å…¶ä»–é€»è¾‘
    
  } catch (error) {
    console.error('åŠ è½½å†…å®¹å¤±è´¥:', error)
  } finally {
    isLoadingContent.value = false
  }
}
```

---

## âœ… ä¿®å¤æ•ˆæœ

### å†…å®¹åˆ‡æ¢æµç¨‹

**ä¿®å¤å‰**ï¼ˆä¸å·¥ä½œï¼‰ï¼š
```
1. ç‚¹å‡»å†…å®¹ B
2. currentContent: A â†’ B (ç›´æ¥å˜åŒ–)
3. editorKey: "A-id-collab" â†’ "B-id-collab"
4. âŒ Editor ç»„ä»¶å¯èƒ½ä¸æ›´æ–°ï¼ˆå¼‚æ­¥é—®é¢˜ï¼‰
```

**ä¿®å¤å**ï¼ˆæ­£å¸¸å·¥ä½œï¼‰ï¼š
```
1. ç‚¹å‡»å†…å®¹ B
2. currentContent: A â†’ null (ä¸´æ—¶æ¸…ç©º)
3. editorKey: "A-id-collab" â†’ "empty-collab"
4. await nextTick() (ç­‰å¾… Vue æ›´æ–°)
5. currentContent: null â†’ B (åŠ è½½æ–°å†…å®¹)
6. editorKey: "empty-collab" â†’ "B-id-collab"
7. âœ… Editor ç»„ä»¶é‡æ–°æŒ‚è½½ï¼ŒåŠ è½½å†…å®¹ B
```

### WebSocket è¡Œä¸º

**å†…å®¹åˆ‡æ¢æ—¶**ï¼š
- âš ï¸ WebSocket ä¼šçŸ­æš‚æ–­å¼€é‡è¿ï¼ˆå› ä¸ºç»„ä»¶é‡æ–°æŒ‚è½½ï¼‰
- âœ… è¿™æ˜¯**å¿…è¦çš„**ï¼Œå› ä¸ºåä½œç¼–è¾‘éœ€è¦åˆ‡æ¢åˆ°æ–°çš„æ–‡æ¡£
- âœ… é‡è¿é€Ÿåº¦å¾ˆå¿«ï¼ˆé€šå¸¸ < 1ç§’ï¼‰

**è‡ªåŠ¨ä¿å­˜æ—¶**ï¼š
- âœ… ä¸ä¼šæ¸…ç©º `currentContent`ï¼ˆå› ä¸º contentId ç›¸åŒï¼‰
- âœ… WebSocket ä¿æŒè¿æ¥
- âœ… æ²¡æœ‰é‡è¿é—®é¢˜

---

## ğŸ“‹ æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. åˆ·æ–°é¡µé¢
2. ç‚¹å‡»ä¸åŒçš„ç« èŠ‚å†…å®¹è¿›è¡Œåˆ‡æ¢
3. è§‚å¯Ÿç¼–è¾‘å™¨æ˜¯å¦æ­£ç¡®åŠ è½½æ–°å†…å®¹

### é¢„æœŸç»“æœ

**å†…å®¹åˆ‡æ¢**ï¼š
```
ğŸ” ç”¨æˆ·é€‰æ‹©å†…å®¹: new-content-id
ğŸ”„ åˆ‡æ¢åˆ°ä¸åŒå†…å®¹ï¼Œä¸´æ—¶æ¸…ç©º currentContent
ğŸ”‘ editorKey è®¡ç®—: { contentId: "empty", mode: "collab" }
ğŸ’€ [Editor] ç»„ä»¶å¸è½½
ğŸ“¦ ä»æœåŠ¡è·å–çš„å®Œæ•´å†…å®¹å¯¹è±¡: { ... }
âœ… å·²è®¾ç½® currentContent.value
ğŸ”‘ editorKey è®¡ç®—: { contentId: "new-content-id", mode: "collab" }
ğŸ¬ [Editor] ç»„ä»¶æŒ‚è½½
ğŸ”Œ ä½¿ç”¨ WebSocket è¿æ¥: ws://localhost:4001
âœ… WebSocket è¿æ¥æˆåŠŸï¼
```

**è‡ªåŠ¨ä¿å­˜**ï¼ˆ30ç§’åï¼‰ï¼š
```
â° è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨è§¦å‘, hasUnsavedChanges: true
ğŸ’¾ æ‰§è¡Œè‡ªåŠ¨ä¿å­˜...
// âœ… æ²¡æœ‰ editorKey å˜åŒ–
// âœ… æ²¡æœ‰ç»„ä»¶å¸è½½/æŒ‚è½½
// âœ… æ²¡æœ‰ WebSocket é‡è¿
```

---

## ğŸ“š ç»éªŒæ€»ç»“

### Vue å“åº”å¼æœ€ä½³å®è·µ

1. **ä½¿ç”¨ `nextTick()` ç¡®ä¿æ›´æ–°æ—¶åº**
   ```typescript
   // âŒ é”™è¯¯ï¼šè¿ç»­æ›´æ–°å¯èƒ½ä¸ä¼šè§¦å‘æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸ
   state.value = null
   state.value = newValue
   
   // âœ… æ­£ç¡®ï¼šä½¿ç”¨ nextTick ç¡®ä¿ä¸­é—´çŠ¶æ€è¢«è¯†åˆ«
   state.value = null
   await nextTick()
   state.value = newValue
   ```

2. **key å±æ€§è¦ç²¾ç¡®åæ˜ ç»„ä»¶èº«ä»½**
   ```typescript
   // âœ… ä½¿ç”¨å”¯ä¸€ ID ä½œä¸º key
   :key="content.id"
   
   // âŒ é¿å…ä½¿ç”¨å¯èƒ½é‡å¤çš„å€¼
   :key="content.type"
   ```

3. **å¹³è¡¡æ€§èƒ½å’Œæ­£ç¡®æ€§**
   - ç»„ä»¶é‡æ–°æŒ‚è½½æœ‰æ€§èƒ½å¼€é”€
   - ä½†ç¡®ä¿æ­£ç¡®æ€§æ›´é‡è¦
   - å¯¹äºç¼–è¾‘å™¨è¿™ç§å¤æ‚ç»„ä»¶ï¼Œé‡æ–°æŒ‚è½½æ˜¯åˆç†çš„

### åä½œç¼–è¾‘ç‰¹æ€§

1. **æ–‡æ¡£åˆ‡æ¢å¿…é¡»é‡è¿**
   - Yjs çš„ `Y.Doc` ç»‘å®šåˆ°ç‰¹å®šæ–‡æ¡£
   - åˆ‡æ¢æ–‡æ¡£éœ€è¦åˆ›å»ºæ–°çš„ `Y.Doc` å’Œ `WebsocketProvider`
   - å› æ­¤ç»„ä»¶é‡æ–°æŒ‚è½½æ˜¯å¿…è¦çš„

2. **è‡ªåŠ¨ä¿å­˜ä¸åº”è§¦å‘é‡è¿**
   - ä¿å­˜æ˜¯é’ˆå¯¹å½“å‰æ–‡æ¡£çš„
   - ä¸æ”¹å˜æ–‡æ¡£èº«ä»½ï¼ˆcontentIdï¼‰
   - åº”è¯¥ä¿æŒè¿æ¥æ´»è·ƒ

---

## âœ… ä¿®å¤æ¸…å•

- [x] ä¿®å¤ `handleContentSelect` å‡½æ•°
- [x] æ·»åŠ  `isDifferentContent` æ£€æŸ¥
- [x] ä½¿ç”¨ `await nextTick()` ç¡®ä¿æ›´æ–°æ—¶åº
- [x] æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•
- [x] åˆ›å»ºä¿®å¤æ–‡æ¡£
- [x] æµ‹è¯•å†…å®¹åˆ‡æ¢åŠŸèƒ½
- [ ] æµ‹è¯•è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼ˆç¡®è®¤ä¸é‡è¿ï¼‰
- [ ] æ¸…ç†å¤šä½™çš„è°ƒè¯•æ—¥å¿—

---

**ä¿®å¤æ—¶é—´**: 2025-10-18  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·éªŒè¯
