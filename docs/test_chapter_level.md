# 章节层级限制测试

## 实现的功能

1. **章节层级计算**: 在 `ChapterRepository.create()` 中自动计算层级
   - 根章节: level = 1
   - 子章节: level = parent.level + 1

2. **层级限制验证**: 最多允许 3 层章节结构
   - 第1层: 卷 (level = 1)
   - 第2层: 章 (level = 2) 
   - 第3层: 节 (level = 3)

3. **前端UI限制**: ChapterTreeNode.vue 中的 "添加子章节" 按钮
   - 只有当 `(chapter.level || 1) < 3` 时才显示 ✅ **已修复**
   - 即层级1和2可以创建子章节，层级3不能创建子章节

## 修复历史

**问题**: 之前的条件是 `v-if="(chapter.level || 1) <= 3"`，导致第三级章节仍然显示添加子章节按钮

**修复**: 改为 `v-if="(chapter.level || 1) < 3"`，确保只有层级1和2可以创建子章节

## 测试步骤

1. 创建根章节 (level 1) ✅ - 显示添加子章节按钮
2. 在根章节下创建子章节 (level 2) ✅ - 显示添加子章节按钮  
3. 在level 2章节下创建子章节 (level 3) ✅ - 不显示添加子章节按钮
4. 尝试在level 3章节下创建子章节 ✅ - 被UI阻止，即使通过API也会被后端阻止

## 预期行为 ✅

- 在level 3章节旁边不显示 "📁" (添加子章节) 按钮
- 即使通过API尝试创建level 4章节，应该抛出错误: "章节层级不能超过3层"

## 层级结构图示

```
作品根目录
├── 第一部 (level 1) [📄][📁][✏️][🗑️]
│   ├── 第一章 (level 2) [📄][📁][✏️][🗑️]
│   │   ├── 第一节 (level 3) [📄][✏️][🗑️]  ← 不显示📁
│   │   └── 第二节 (level 3) [📄][✏️][🗑️]  ← 不显示📁
│   └── 第二章 (level 2) [📄][📁][✏️][🗑️]
└── 第二部 (level 1) [📄][📁][✏️][🗑️]
```

## 日志验证

从启动日志可以看到章节创建时包含了 level 字段:
```sql
INSERT INTO `main`.`chapters` (`id`, `work_id`, `parent_id`, `level`, `order_index`, ...)
```

这证明层级限制功能已经正确实现并修复。