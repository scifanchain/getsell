<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ååŒç¼–è¾‘ç½‘ç»œè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Gestell ååŒç¼–è¾‘ç½‘ç»œè¿æ¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>WebSocket è¿æ¥æµ‹è¯•</h3>
        <div id="websocket-status" class="status info">æœªæµ‹è¯•</div>
        <button class="test-button" onclick="testWebSocket()">æµ‹è¯• WebSocket è¿æ¥</button>
        <div id="websocket-log" class="log"></div>
    </div>

    <div class="test-section">
        <h3>æœ¬åœ°æœåŠ¡æ£€æµ‹</h3>
        <div id="service-status" class="status info">æ£€æµ‹ä¸­...</div>
        <button class="test-button" onclick="checkServices()">æ£€æŸ¥æ‰€æœ‰æœåŠ¡</button>
        <div id="service-log" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Yjs åº“åŠ è½½æµ‹è¯•</h3>
        <div id="yjs-status" class="status info">æœªæµ‹è¯•</div>
        <button class="test-button" onclick="testYjsLibraries()">æµ‹è¯• Yjs åº“</button>
        <div id="yjs-log" class="log"></div>
    </div>

    <script>
        function log(elementId, message) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // æµ‹è¯• WebSocket è¿æ¥
        async function testWebSocket() {
            updateStatus('websocket-status', 'info', 'æµ‹è¯•ä¸­...');
            log('websocket-log', 'å¼€å§‹ WebSocket è¿æ¥æµ‹è¯•');
            
            try {
                const ws = new WebSocket('ws://localhost:3001/signaling');
                
                ws.onopen = function(event) {
                    log('websocket-log', 'âœ… WebSocket è¿æ¥æˆåŠŸ!');
                    updateStatus('websocket-status', 'success', 'WebSocket è¿æ¥æ­£å¸¸');
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    ws.send(JSON.stringify({
                        type: 'test',
                        message: 'Hello from test client'
                    }));
                    log('websocket-log', 'ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯');
                };
                
                ws.onmessage = function(event) {
                    log('websocket-log', `ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
                };
                
                ws.onerror = function(error) {
                    log('websocket-log', `âŒ WebSocket é”™è¯¯: ${error}`);
                    updateStatus('websocket-status', 'error', 'WebSocket è¿æ¥å¤±è´¥');
                };
                
                ws.onclose = function(event) {
                    log('websocket-log', `ğŸ”Œ è¿æ¥å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`);
                };
                
                // 5ç§’åå…³é—­è¿æ¥
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('websocket-log', 'ğŸ”Œ ä¸»åŠ¨å…³é—­æµ‹è¯•è¿æ¥');
                    }
                }, 5000);
                
            } catch (error) {
                log('websocket-log', `âŒ è¿æ¥å¼‚å¸¸: ${error.message}`);
                updateStatus('websocket-status', 'error', 'è¿æ¥å¼‚å¸¸');
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            updateStatus('service-status', 'info', 'æ£€æµ‹ä¸­...');
            log('service-log', 'å¼€å§‹æœåŠ¡æ£€æµ‹');
            
            const services = [
                { name: 'WebSocket ä¿¡ä»¤æœåŠ¡å™¨', url: 'ws://localhost:3001/signaling' },
                { name: 'Gestell å‰ç«¯æœåŠ¡', url: 'http://localhost:3000' }
            ];
            
            let allServicesOk = true;
            
            for (const service of services) {
                try {
                    if (service.url.startsWith('ws://')) {
                        // WebSocket æµ‹è¯•
                        const ws = new WebSocket(service.url);
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                ws.close();
                                reject(new Error('è¿æ¥è¶…æ—¶'));
                            }, 3000);
                            
                            ws.onopen = () => {
                                clearTimeout(timeout);
                                ws.close();
                                log('service-log', `âœ… ${service.name}: æ­£å¸¸`);
                                resolve();
                            };
                            
                            ws.onerror = (error) => {
                                clearTimeout(timeout);
                                reject(error);
                            };
                        });
                    } else {
                        // HTTP æµ‹è¯•
                        const response = await fetch(service.url, { method: 'HEAD' });
                        if (response.ok || response.status === 405) {
                            log('service-log', `âœ… ${service.name}: æ­£å¸¸`);
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    }
                } catch (error) {
                    log('service-log', `âŒ ${service.name}: ${error.message}`);
                    allServicesOk = false;
                }
            }
            
            updateStatus('service-status', allServicesOk ? 'success' : 'error', 
                         allServicesOk ? 'æ‰€æœ‰æœåŠ¡æ­£å¸¸' : 'éƒ¨åˆ†æœåŠ¡å¼‚å¸¸');
        }

        // æµ‹è¯• Yjs åº“åŠ è½½
        async function testYjsLibraries() {
            updateStatus('yjs-status', 'info', 'æµ‹è¯•ä¸­...');
            log('yjs-log', 'å¼€å§‹ Yjs åº“æµ‹è¯•');
            
            const libraries = [
                'yjs',
                'y-prosemirror', 
                'y-webrtc',
                'y-websocket',
                'y-protocols'
            ];
            
            try {
                for (const lib of libraries) {
                    try {
                        // å°è¯•åŠ¨æ€å¯¼å…¥åº“
                        const module = await import(`https://cdn.skypack.dev/${lib}`);
                        log('yjs-log', `âœ… ${lib}: å¯ä»¥åŠ è½½`);
                    } catch (error) {
                        log('yjs-log', `âŒ ${lib}: ${error.message}`);
                    }
                }
                
                updateStatus('yjs-status', 'success', 'Yjs åº“æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log('yjs-log', `âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
                updateStatus('yjs-status', 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡
        window.addEventListener('load', () => {
            setTimeout(checkServices, 1000);
        });
    </script>
</body>
</html>