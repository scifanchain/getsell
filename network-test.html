<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>协同编辑网络连接测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🔧 Gestell 协同编辑网络连接测试</h1>
    
    <div class="test-section">
        <h3>WebSocket 连接测试</h3>
        <div id="websocket-status" class="status info">未测试</div>
        <button class="test-button" onclick="testWebSocket()">测试 WebSocket 连接</button>
        <div id="websocket-log" class="log"></div>
    </div>

    <div class="test-section">
        <h3>本地服务检测</h3>
        <div id="service-status" class="status info">检测中...</div>
        <button class="test-button" onclick="checkServices()">检查所有服务</button>
        <div id="service-log" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Yjs 库加载测试</h3>
        <div id="yjs-status" class="status info">未测试</div>
        <button class="test-button" onclick="testYjsLibraries()">测试 Yjs 库</button>
        <div id="yjs-log" class="log"></div>
    </div>

    <script>
        function log(elementId, message) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // 测试 WebSocket 连接
        async function testWebSocket() {
            updateStatus('websocket-status', 'info', '测试中...');
            log('websocket-log', '开始 WebSocket 连接测试');
            
            try {
                const ws = new WebSocket('ws://localhost:3001/signaling');
                
                ws.onopen = function(event) {
                    log('websocket-log', '✅ WebSocket 连接成功!');
                    updateStatus('websocket-status', 'success', 'WebSocket 连接正常');
                    
                    // 发送测试消息
                    ws.send(JSON.stringify({
                        type: 'test',
                        message: 'Hello from test client'
                    }));
                    log('websocket-log', '📤 发送测试消息');
                };
                
                ws.onmessage = function(event) {
                    log('websocket-log', `📥 收到消息: ${event.data}`);
                };
                
                ws.onerror = function(error) {
                    log('websocket-log', `❌ WebSocket 错误: ${error}`);
                    updateStatus('websocket-status', 'error', 'WebSocket 连接失败');
                };
                
                ws.onclose = function(event) {
                    log('websocket-log', `🔌 连接关闭: 代码=${event.code}, 原因=${event.reason}`);
                };
                
                // 5秒后关闭连接
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('websocket-log', '🔌 主动关闭测试连接');
                    }
                }, 5000);
                
            } catch (error) {
                log('websocket-log', `❌ 连接异常: ${error.message}`);
                updateStatus('websocket-status', 'error', '连接异常');
            }
        }

        // 检查服务状态
        async function checkServices() {
            updateStatus('service-status', 'info', '检测中...');
            log('service-log', '开始服务检测');
            
            const services = [
                { name: 'WebSocket 信令服务器', url: 'ws://localhost:3001/signaling' },
                { name: 'Gestell 前端服务', url: 'http://localhost:3000' }
            ];
            
            let allServicesOk = true;
            
            for (const service of services) {
                try {
                    if (service.url.startsWith('ws://')) {
                        // WebSocket 测试
                        const ws = new WebSocket(service.url);
                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => {
                                ws.close();
                                reject(new Error('连接超时'));
                            }, 3000);
                            
                            ws.onopen = () => {
                                clearTimeout(timeout);
                                ws.close();
                                log('service-log', `✅ ${service.name}: 正常`);
                                resolve();
                            };
                            
                            ws.onerror = (error) => {
                                clearTimeout(timeout);
                                reject(error);
                            };
                        });
                    } else {
                        // HTTP 测试
                        const response = await fetch(service.url, { method: 'HEAD' });
                        if (response.ok || response.status === 405) {
                            log('service-log', `✅ ${service.name}: 正常`);
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    }
                } catch (error) {
                    log('service-log', `❌ ${service.name}: ${error.message}`);
                    allServicesOk = false;
                }
            }
            
            updateStatus('service-status', allServicesOk ? 'success' : 'error', 
                         allServicesOk ? '所有服务正常' : '部分服务异常');
        }

        // 测试 Yjs 库加载
        async function testYjsLibraries() {
            updateStatus('yjs-status', 'info', '测试中...');
            log('yjs-log', '开始 Yjs 库测试');
            
            const libraries = [
                'yjs',
                'y-prosemirror', 
                'y-webrtc',
                'y-websocket',
                'y-protocols'
            ];
            
            try {
                for (const lib of libraries) {
                    try {
                        // 尝试动态导入库
                        const module = await import(`https://cdn.skypack.dev/${lib}`);
                        log('yjs-log', `✅ ${lib}: 可以加载`);
                    } catch (error) {
                        log('yjs-log', `❌ ${lib}: ${error.message}`);
                    }
                }
                
                updateStatus('yjs-status', 'success', 'Yjs 库测试完成');
                
            } catch (error) {
                log('yjs-log', `❌ 测试异常: ${error.message}`);
                updateStatus('yjs-status', 'error', '测试失败');
            }
        }

        // 页面加载时自动检查服务
        window.addEventListener('load', () => {
            setTimeout(checkServices, 1000);
        });
    </script>
</body>
</html>