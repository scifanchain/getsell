<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库性能对比测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        
        .test-section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        
        .test-results {
            background: #0f3460;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            background: #e94560;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #d73550;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .mode-result {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid;
        }
        
        .hybrid-mode {
            border-color: #4caf50;
        }
        
        .prisma-mode {
            border-color: #2196f3;
        }
    </style>
</head>
<body>
    <h1>🔬 Gestell 数据库性能对比测试</h1>
    
    <div class="test-section">
        <h2>📊 当前数据库统计</h2>
        <button class="btn" onclick="getCurrentStats()">获取当前统计</button>
        <div id="current-stats" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>⚡ 性能对比测试</h2>
        <p>这个测试将比较混合模式(better-sqlite3同步)和Prisma模式(异步)的性能差异</p>
        
        <div style="margin: 15px 0;">
            <button class="btn" onclick="runPerformanceTest()">开始性能测试</button>
            <button class="btn" onclick="clearResults()">清除结果</button>
        </div>
        
        <div class="performance-comparison" id="performance-results" style="display: none;">
            <div class="mode-result hybrid-mode">
                <h3>🔀 混合模式 (Sync)</h3>
                <div id="hybrid-results"></div>
            </div>
            <div class="mode-result prisma-mode">
                <h3>🔍 Prisma模式 (Async)</h3>
                <div id="prisma-results"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>🧪 功能测试</h2>
        <div style="margin: 15px 0;">
            <button class="btn" onclick="testCreateWork()">测试创建作品</button>
            <button class="btn" onclick="testCreateChapter()">测试创建章节</button>
            <button class="btn" onclick="testListWorks()">测试获取作品列表</button>
        </div>
        <div id="function-test-results" class="test-results"></div>
    </div>

    <script>
        let testWorkId = null;
        
        async function getCurrentStats() {
            try {
                const result = await window.electronAPI.invoke('system:getStats');
                document.getElementById('current-stats').innerHTML = `
                    <h4>📈 数据库统计</h4>
                    <div class="stats">
                        <div class="stat-item">
                            <strong>作者数量</strong><br>
                            ${result.stats.authors || 0}
                        </div>
                        <div class="stat-item">
                            <strong>作品数量</strong><br>
                            ${result.stats.works || 0}
                        </div>
                        <div class="stat-item">
                            <strong>章节数量</strong><br>
                            ${result.stats.chapters || 0}
                        </div>
                        <div class="stat-item">
                            <strong>内容数量</strong><br>
                            ${result.stats.contents || 0}
                        </div>
                    </div>
                    <pre>${JSON.stringify(result.stats, null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('current-stats').innerHTML = `❌ 错误: ${error.message}`;
            }
        }
        
        async function runPerformanceTest() {
            const performanceResults = document.getElementById('performance-results');
            const hybridResults = document.getElementById('hybrid-results');
            const prismaResults = document.getElementById('prisma-results');
            
            performanceResults.style.display = 'grid';
            hybridResults.innerHTML = '⏳ 测试中...';
            prismaResults.innerHTML = '⏳ 测试中...';
            
            // 测试混合模式性能
            try {
                const hybridStart = performance.now();
                
                // 执行一系列操作
                const statsResult = await window.electronAPI.invoke('system:getStats');
                const listResult = await window.electronAPI.invoke('project:list', 'user_mock_001');
                
                const hybridEnd = performance.now();
                const hybridTime = hybridEnd - hybridStart;
                
                hybridResults.innerHTML = `
                    <div>⏱️ 总耗时: <strong>${hybridTime.toFixed(2)}ms</strong></div>
                    <div>📊 获取统计: ✅</div>
                    <div>📚 获取作品列表: ✅</div>
                    <div>📈 作品数量: ${listResult.projects?.length || 0}</div>
                    <div style="margin-top: 10px; color: #4caf50;">
                        <strong>优势: 同步操作，无Promise开销</strong>
                    </div>
                `;
            } catch (error) {
                hybridResults.innerHTML = `❌ 混合模式测试失败: ${error.message}`;
            }
            
            // 模拟Prisma模式的结果（因为我们当前运行的是混合模式）
            prismaResults.innerHTML = `
                <div>⏱️ 总耗时: <strong>~${(Math.random() * 10 + 15).toFixed(2)}ms</strong></div>
                <div>📊 获取统计: ✅</div>
                <div>📚 获取作品列表: ✅</div>
                <div>📈 关系查询: ✅</div>
                <div style="margin-top: 10px; color: #2196f3;">
                    <strong>优势: 类型安全，复杂关系查询</strong>
                </div>
                <div style="color: #ff9800; font-size: 0.9em;">
                    * 模拟结果，实际可能有Promise开销
                </div>
            `;
        }
        
        async function testCreateWork() {
            const results = document.getElementById('function-test-results');
            results.innerHTML = '⏳ 创建测试作品...';
            
            try {
                const start = performance.now();
                const result = await window.electronAPI.invoke('project:create', {
                    title: `测试作品 ${Date.now()}`,
                    description: '这是一个性能测试作品',
                    genre: 'cyberpunk',
                    authorId: 'user_mock_001'
                });
                const end = performance.now();
                
                if (result.success) {
                    testWorkId = result.projectId;
                    results.innerHTML = `
                        ✅ 作品创建成功<br>
                        📝 作品ID: ${result.projectId}<br>
                        ⏱️ 耗时: ${(end - start).toFixed(2)}ms
                    `;
                } else {
                    results.innerHTML = `❌ 创建失败: ${result.error}`;
                }
            } catch (error) {
                results.innerHTML = `❌ 错误: ${error.message}`;
            }
        }
        
        async function testCreateChapter() {
            if (!testWorkId) {
                document.getElementById('function-test-results').innerHTML = '❌ 请先创建一个作品';
                return;
            }
            
            const results = document.getElementById('function-test-results');
            results.innerHTML = '⏳ 创建测试章节...';
            
            try {
                const start = performance.now();
                const result = await window.electronAPI.invoke('chapter:create', {
                    projectId: testWorkId,
                    title: `测试章节 ${Date.now()}`,
                    description: '这是一个性能测试章节',
                    type: 'chapter'
                });
                const end = performance.now();
                
                if (result.success) {
                    results.innerHTML = `
                        ✅ 章节创建成功<br>
                        📖 章节ID: ${result.chapterId}<br>
                        ⏱️ 耗时: ${(end - start).toFixed(2)}ms
                    `;
                } else {
                    results.innerHTML = `❌ 创建失败: ${result.error}`;
                }
            } catch (error) {
                results.innerHTML = `❌ 错误: ${error.message}`;
            }
        }
        
        async function testListWorks() {
            const results = document.getElementById('function-test-results');
            results.innerHTML = '⏳ 获取作品列表...';
            
            try {
                const start = performance.now();
                const result = await window.electronAPI.invoke('project:list', 'user_mock_001');
                const end = performance.now();
                
                if (result.success) {
                    results.innerHTML = `
                        ✅ 获取成功<br>
                        📚 作品数量: ${result.projects.length}<br>
                        ⏱️ 耗时: ${(end - start).toFixed(2)}ms<br>
                        <details style="margin-top: 10px;">
                            <summary>📋 作品列表详情</summary>
                            <pre style="font-size: 0.8em; margin-top: 5px;">${JSON.stringify(result.projects, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    results.innerHTML = `❌ 获取失败: ${result.error}`;
                }
            } catch (error) {
                results.innerHTML = `❌ 错误: ${error.message}`;
            }
        }
        
        function clearResults() {
            document.getElementById('performance-results').style.display = 'none';
            document.getElementById('function-test-results').innerHTML = '';
        }
        
        // 页面加载时自动获取统计
        window.addEventListener('load', getCurrentStats);
    </script>
</body>
</html>