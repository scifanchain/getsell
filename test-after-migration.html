<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯• Prisma ç§»é™¤åçš„åŠŸèƒ½</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .progress {
            margin: 10px 0;
            font-style: italic;
            color: #7f8c8d;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ CR-SQLite ç»Ÿä¸€æ¶æ„æµ‹è¯•</h1>
        <p><strong>Prisma å·²å®Œå…¨ç§»é™¤ï¼Œç°åœ¨ 100% ä½¿ç”¨ CR-SQLite!</strong></p>

        <div class="test-section">
            <h2>ğŸ“Š 1. åŸºç¡€ä»“å‚¨æµ‹è¯•</h2>
            <button onclick="runBasicTests()">è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
            <div id="basic-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª 2. å®Œæ•´æµ‹è¯•å¥—ä»¶ (17é¡¹)</h2>
            <button onclick="runFullTests()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="full-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ 3. åˆ›å»ºæµ‹è¯•æ•°æ®</h2>
            <button onclick="createTestData()">åˆ›å»ºä½œå“å’Œç« èŠ‚</button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¤ 4. Yjs åä½œæ–‡æ¡£æµ‹è¯•</h2>
            <button onclick="testCollaboration()">æµ‹è¯•åä½œæ–‡æ¡£å­˜å‚¨</button>
            <div id="collab-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” 5. æŸ¥è¯¢åä½œæ–‡æ¡£</h2>
            <button onclick="queryCollabDocs()">æŸ¥è¯¢æ‰€æœ‰åä½œæ–‡æ¡£</button>
            <div id="query-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ˆ 6. ç»Ÿè®¡ä¿¡æ¯</h2>
            <button onclick="getStats()">è·å–ç»Ÿè®¡æ•°æ®</button>
            <div id="stats-result"></div>
        </div>
    </div>

    <script>
        const output = (id, content, isError = false) => {
            const el = document.getElementById(id);
            el.textContent = content;
            el.style.borderLeftColor = isError ? '#e74c3c' : '#27ae60';
        };

        async function runBasicTests() {
            output('basic-result', 'â³ è¿è¡ŒåŸºç¡€æµ‹è¯•...');
            try {
                const result = await window.electron.invoke('test:crsqlite:basic');
                output('basic-result', JSON.stringify(result, null, 2));
            } catch (error) {
                output('basic-result', 'âŒ é”™è¯¯: ' + error.message, true);
            }
        }

        async function runFullTests() {
            output('full-result', 'â³ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...');
            try {
                const result = await window.electron.invoke('test:crsqlite:full');
                const summary = `
âœ… æµ‹è¯•å®Œæˆ!

æ€»è®¡: ${result.totalTests} é¡¹
æˆåŠŸ: ${result.successCount} é¡¹
å¤±è´¥: ${result.failureCount} é¡¹
è·³è¿‡: ${result.skippedCount} é¡¹

é€šè¿‡ç‡: ${((result.successCount / result.totalTests) * 100).toFixed(1)}%

è¯¦ç»†ç»“æœ:
${result.results.map((r, i) => 
    `${i + 1}. ${r.passed ? 'âœ…' : 'âŒ'} ${r.testName} (${r.duration}ms)`
).join('\n')}
                `;
                output('full-result', summary);
            } catch (error) {
                output('full-result', 'âŒ é”™è¯¯: ' + error.message, true);
            }
        }

        async function createTestData() {
            output('create-result', 'â³ åˆ›å»ºæµ‹è¯•æ•°æ®...');
            try {
                // åˆ›å»ºç”¨æˆ·
                const user = await window.electron.invoke('user:create', {
                    name: 'æµ‹è¯•ç”¨æˆ·',
                    email: 'test@example.com',
                    role: 'user'
                });

                // åˆ›å»ºä½œå“
                const work = await window.electron.invoke('work:create', {
                    title: 'CR-SQLite æµ‹è¯•ä½œå“',
                    authorId: user.id,
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• CR-SQLite çš„ä½œå“'
                });

                // åˆ›å»ºç« èŠ‚
                const chapter = await window.electron.invoke('chapter:create', {
                    title: 'ç¬¬ä¸€ç« ï¼šæµ‹è¯•ç« èŠ‚',
                    workId: work.id,
                    level: 1,
                    orderIndex: 0
                });

                // åˆ›å»ºå†…å®¹
                const content = await window.electron.invoke('content:create', {
                    chapterId: chapter.id,
                    workId: work.id,
                    contentType: 'text',
                    contentJson: JSON.stringify({
                        type: 'doc',
                        content: [{
                            type: 'paragraph',
                            content: [{ type: 'text', text: 'è¿™æ˜¯æµ‹è¯•å†…å®¹' }]
                        }]
                    })
                });

                const result = `
âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ!

ç”¨æˆ·: ${user.name} (${user.id})
ä½œå“: ${work.title} (${work.id})
ç« èŠ‚: ${chapter.title} (${chapter.id})
å†…å®¹: ${content.id}
å­—æ•°: ${content.wordCount || 0}
                `;
                output('create-result', result);

                // ä¿å­˜ workId ä¾›åç»­æµ‹è¯•ä½¿ç”¨
                window._testWorkId = work.id;
                window._testContentId = content.id;
            } catch (error) {
                output('create-result', 'âŒ é”™è¯¯: ' + error.message, true);
            }
        }

        async function testCollaboration() {
            output('collab-result', 'â³ æµ‹è¯•åä½œæ–‡æ¡£å­˜å‚¨...');
            try {
                if (!window._testContentId) {
                    throw new Error('è¯·å…ˆè¿è¡Œ"åˆ›å»ºæµ‹è¯•æ•°æ®"');
                }

                // æ¨¡æ‹Ÿ Yjs çŠ¶æ€æ•°æ®
                const yjsState = new Uint8Array([1, 2, 3, 4, 5]);
                const stateVector = new Uint8Array([6, 7, 8]);

                // è¿™é‡Œéœ€è¦è°ƒç”¨å®é™…çš„åä½œæ–‡æ¡£ä¿å­˜æ¥å£
                // ç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰åœ¨ IPC ä¸­æ³¨å†Œåä½œç›¸å…³çš„å¤„ç†å™¨ï¼Œ
                // è¿™é‡Œå…ˆå±•ç¤ºå¦‚ä½•ä½¿ç”¨

                const result = `
âœ… åä½œæ–‡æ¡£æµ‹è¯•å‡†å¤‡å°±ç»ª!

å†…å®¹ID: ${window._testContentId}
ä½œå“ID: ${window._testWorkId}

Yjs çŠ¶æ€å¤§å°: ${yjsState.length} bytes
çŠ¶æ€å‘é‡å¤§å°: ${stateVector.length} bytes

æ³¨æ„: éœ€è¦åœ¨ IPC å¤„ç†å™¨ä¸­æ·»åŠ åä½œæ–‡æ¡£çš„ä¿å­˜/æŸ¥è¯¢æ¥å£ã€‚
                `;
                output('collab-result', result);
            } catch (error) {
                output('collab-result', 'âŒ é”™è¯¯: ' + error.message, true);
            }
        }

        async function queryCollabDocs() {
            output('query-result', 'â³ æŸ¥è¯¢åä½œæ–‡æ¡£...');
            try {
                // è¿™é‡Œéœ€è¦è°ƒç”¨æŸ¥è¯¢åä½œæ–‡æ¡£çš„æ¥å£
                // æš‚æ—¶æ˜¾ç¤ºè¯´æ˜
                const result = `
ğŸ“‹ åä½œæ–‡æ¡£æŸ¥è¯¢åŠŸèƒ½

å½“å‰çŠ¶æ€: CRSQLiteCollaborationRepository å·²åˆ›å»º
æ•°æ®è¡¨: collaborative_documents (å·²å¯ç”¨ CRDT)

éœ€è¦æ·»åŠ çš„ IPC å¤„ç†å™¨:
- collaboration:save
- collaboration:findById
- collaboration:findByContentId
- collaboration:findByWorkId
- collaboration:update

è¡¨ç»“æ„:
- id (TEXT)
- content_id (TEXT)
- work_id (TEXT)
- yjs_state (BLOB)
- state_vector (BLOB)
- last_sync_at (INTEGER)
- created_at (INTEGER)
- updated_at (INTEGER)
                `;
                output('query-result', result);
            } catch (error) {
                output('query-result', 'âŒ é”™è¯¯: ' + error.message, true);
            }
        }

        async function getStats() {
            const container = document.getElementById('stats-result');
            container.innerHTML = '<div class="progress">â³ è·å–ç»Ÿè®¡æ•°æ®...</div>';
            
            try {
                // è·å–å„ç§ç»Ÿè®¡æ•°æ®
                const [works, users] = await Promise.all([
                    window.electron.invoke('work:findAll'),
                    window.electron.invoke('user:findAll')
                ]);

                const statsHtml = `
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                            <div class="stat-value">${users.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»ä½œå“æ•°</div>
                            <div class="stat-value">${works.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ•°æ®åº“</div>
                            <div class="stat-value">CR-SQLite</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Prisma</div>
                            <div class="stat-value">å·²ç§»é™¤ âœ¨</div>
                        </div>
                    </div>
                    <div class="result">
âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ!

æ•°æ®åº“: CR-SQLite (ç»Ÿä¸€æ¶æ„)
CRDT: å·²å¯ç”¨ (6ä¸ªè¡¨)
åä½œ: CR-SQLite (æ›¿ä»£ Prisma)
                    </div>
                `;
                container.innerHTML = statsHtml;
            } catch (error) {
                container.innerHTML = `<div class="result" style="border-left-color: #e74c3c;">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        window.addEventListener('load', () => {
            console.log('ğŸš€ CR-SQLite æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('âœ¨ Prisma å·²å®Œå…¨ç§»é™¤');
            console.log('ğŸ“Š ç°åœ¨ 100% ä½¿ç”¨ CR-SQLite');
        });
    </script>
</body>
</html>
