# 🖥️ Gestell Electron 应用协同编辑测试指南

## 🔍 当前环境确认

✅ **Electron 桌面应用运行中**
✅ **后端服务**: WebSocket 信令服务器 (ws://localhost:3001/signaling)
✅ **协同编辑组件**: 已集成到 WritingView

## 🚀 开始测试协同编辑功能

### 第一步：确认应用状态

1. **检查 Electron 应用界面**
   - 确认应用窗口正常显示
   - 检查菜单栏和工具栏是否正常

2. **确认网络连接**
   - Electron 应用应该能够访问本地 WebSocket 服务器
   - 检查是否有网络连接错误提示

### 第二步：登录和准备测试内容

1. **用户登录**
   - 在 Electron 应用中登录您的账户
   - 如果是首次使用，请先创建账户

2. **准备测试作品**
   - 创建新作品或打开现有作品
   - 确保作品中有至少一个章节可用于测试

### 第三步：进入协同编辑模式

1. **进入写作界面**
   - 点击章节进入写作模式
   - 观察编辑器界面布局

2. **查找协同模式按钮**
   - 在编辑器上方应该看到模式切换按钮
   - 默认状态：📝 **单机模式**

3. **启用协同编辑**
   - 点击切换按钮变为：🤝 **协同模式**
   - 观察界面变化：
     ```
     ┌─ 协作状态栏 ─────────────────────┐
     │ 🟢 已连接    2 位协作者在线      │
     │                           👤👤  │
     └─────────────────────────────────┘
     ┌─ 编辑器菜单 ─────────────────────┐
     │ B I U ...                      │
     └─────────────────────────────────┘
     ┌─ 编辑器内容区 ───────────────────┐
     │ 您的文档内容...                  │
     │                                │
     └─────────────────────────────────┘
     ┌─ 编辑器底部 ─────────────────────┐
     │ 🤝 退出协作                      │
     └─────────────────────────────────┘
     ```

### 第四步：创建第二个协同客户端

**选项 A：启动第二个 Electron 实例（如果支持）**
```bash
# 在命令行中运行
cd "d:\gestell"
npm run dev
```

**选项 B：使用 Web 浏览器作为第二个客户端**
1. 打开 Chrome/Edge 浏览器
2. 访问：http://localhost:3000
3. 登录并进入相同的作品和章节
4. 切换到协同模式

### 第五步：测试实时协同编辑

1. **基础同步测试**
   - 在 Electron 应用中输入文字
   - 观察浏览器窗口是否实时显示
   - 反向测试：在浏览器中输入，观察 Electron 应用

2. **协作感知测试**
   - 查看协作者列表是否显示在线用户
   - 观察连接状态指示器：
     - 🟢 已连接
     - 🟡 连接中...
     - 🔴 未连接

3. **并发编辑测试**
   - 同时在两个客户端编辑不同段落
   - 测试同一位置的冲突处理
   - 观察 Yjs CRDT 算法的合并效果

### 第六步：Electron 特定场景测试

1. **窗口管理测试**
   - 最小化 Electron 窗口，然后恢复
   - 检查协同连接是否保持
   - 测试窗口焦点切换

2. **系统休眠测试**
   - 让系统进入休眠/睡眠状态
   - 唤醒后检查连接自动恢复
   - 验证数据同步完整性

3. **网络切换测试**
   - 断开网络连接
   - 观察连接状态变化
   - 重新连接网络
   - 验证自动重连和数据同步

## 🔧 Electron 应用调试

### 打开开发者工具
在 Electron 应用中：
- **Windows/Linux**: `Ctrl + Shift + I`
- **macOS**: `Cmd + Option + I`

### 查看日志信息
1. **主进程日志**: 在启动应用的终端窗口中查看
2. **渲染进程日志**: 在开发者工具的 Console 标签中查看

### 常见调试点
```javascript
// 检查 WebSocket 连接
console.log('WebSocket 状态:', websocketProvider?.ws?.readyState)

// 检查 Yjs 文档状态
console.log('Yjs 文档大小:', ydoc?.getMap().size)

// 检查协作者信息
console.log('当前协作者:', awareness?.getStates())
```

## 📊 预期测试结果

### ✅ 功能检查清单

| 功能项 | 状态 | 备注 |
|--------|------|------|
| Electron 应用启动 | ⏳ | 应用正常打开 |
| 用户登录 | ⏳ | 账户系统正常工作 |
| 协同模式切换 | ⏳ | 按钮响应和界面变化 |
| WebSocket 连接 | ⏳ | 连接状态正确显示 |
| 实时文字同步 | ⏳ | 输入立即同步到其他客户端 |
| 协作者显示 | ⏳ | 在线用户列表正确 |
| 冲突解决 | ⏳ | CRDT 算法正确合并 |
| 窗口管理 | ⏳ | 最小化/恢复正常 |
| 网络重连 | ⏳ | 断网重连机制工作 |
| 数据持久化 | ⏳ | 重启应用后数据保持 |

### 🚨 需要关注的 Electron 特有问题

1. **主进程与渲染进程通信**
   - IPC 通信是否正常
   - 数据传递是否完整

2. **安全策略**
   - CSP (Content Security Policy) 限制
   - Node.js 集成设置

3. **文件访问权限**
   - 本地文件读写权限
   - SQLite 数据库访问

4. **性能问题**
   - 内存使用情况
   - CPU 占用率
   - 渲染性能

## 🐛 故障排除

### 常见问题及解决方案

1. **协同模式按钮不出现**
   ```javascript
   // 检查用户登录状态
   console.log('当前用户:', currentUser.value)
   // 检查内容 ID
   console.log('内容 ID:', currentContent.value?.id)
   ```

2. **WebSocket 连接失败**
   - 检查防火墙设置
   - 确认端口 3001 没有被其他程序占用
   - 查看主进程日志中的错误信息

3. **实时同步不工作**
   - 打开开发者工具查看网络请求
   - 检查 Yjs 相关错误
   - 验证 WebRTC 连接状态

4. **Electron 应用崩溃**
   - 查看主进程错误日志
   - 检查 Node.js 版本兼容性
   - 验证依赖包安装完整性

## 📞 获取帮助

如果测试过程中遇到问题：

1. **收集错误信息**
   - 开发者工具 Console 日志
   - 主进程终端输出
   - 错误堆栈信息

2. **记录操作步骤**
   - 详细描述重现步骤
   - 记录预期行为 vs 实际行为

3. **系统信息**
   - 操作系统版本
   - Electron 版本
   - Node.js 版本

---

**提示**: Electron 应用的协同编辑功能结合了桌面应用的性能优势和 Web 技术的灵活性，测试时请特别关注跨进程通信和本地数据持久化的表现。